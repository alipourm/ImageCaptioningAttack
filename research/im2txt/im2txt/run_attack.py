# Copyright 2016 The TensorFlow Authors. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# ==============================================================================
r"""Generate captions for images using default beam search parameters."""

from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import math
import os
import re
import numpy as np

import tensorflow as tf

from im2txt import configuration
from im2txt import attack_wrapper
from im2txt import inference_wrapper
from im2txt.inference_utils import caption_generator
from im2txt.inference_utils import vocabulary

FLAGS = tf.flags.FLAGS

tf.flags.DEFINE_string("checkpoint_path", "",
                       "Model checkpoint file or directory containing a "
                       "model checkpoint file.")
tf.flags.DEFINE_string("vocab_file", "", "Text file containing the vocabulary.")
tf.flags.DEFINE_string("input_files", "",
                       "File pattern or comma-separated list of file patterns "
                       "of image files.")

tf.logging.set_verbosity(tf.logging.INFO)


def main(_):
  # Build the inference graph.
  g = tf.Graph()
  with g.as_default():
    
    model = attack_wrapper.AttackWrapper()
    restore_fn = model.build_graph_from_config(configuration.ModelConfig(),
                                               FLAGS.checkpoint_path)
  # g.finalize()

  # Create the vocabulary.
  vocab = vocabulary.Vocabulary(FLAGS.vocab_file)

  filenames = []
  for file_pattern in FLAGS.input_files.split(","):
    filenames.extend(tf.gfile.Glob(file_pattern))
  tf.logging.info("Running caption generation on %d files matching %s",
                  len(filenames), FLAGS.input_files)

  with tf.Session(graph=g) as sess:
    # Load the model from checkpoint.
    restore_fn(sess)

    # Prepare the caption generator. Here we are implicitly using the default
    # beam search parameters. See caption_generator.py for a description of the
    # available beam search parameters.
    

    for filename in filenames:
      with tf.gfile.GFile(filename, "rb") as f:
        image = f.read()
      
      # preprocess image
      # testing computation graph
      image_placeholder = tf.placeholder(dtype=tf.string, shape=[])
      preprocessor = model.model.process_image(image_placeholder)
      raw_image = sess.run(preprocessor, feed_dict = {image_placeholder: image})
      print('raw image size:', raw_image.shape)

      new_sentence = "kite"
      new_sentence = "a man riding a wave on top of a surfboard ."
      new_sentence = new_sentence.split()
      print("My new sentence:", new_sentence)
      new_caption = [vocab.start_id]+[vocab.word_to_id(w) for w in new_sentence] + [vocab.end_id]
      new_caption=[new_caption]
      print("My new id:", new_caption)
      new_mask = np.ones(np.shape(new_caption))
      print("Probability by attack_step:", model.attack_step(sess, new_caption, new_mask, raw_image))
      
      raw_image_placeholder = tf.placeholder(dtype=tf.float32, 
                                             shape=[299, 299, 3])
      caption_placeholder = tf.placeholder(dtype=tf.int64, shape=[None,None])
      mask_placeholder = tf.placeholder(dtype=tf.int64,shape=[None,None])
      endpoint = model.predict(sess, caption_placeholder, mask_placeholder, raw_image_placeholder)
      grad_op = tf.gradients(endpoint, raw_image_placeholder)
      grads, log_probs = sess.run([grad_op, endpoint], 
              feed_dict={
                  caption_placeholder: new_caption,
                  mask_placeholder: new_mask,
                  raw_image_placeholder: raw_image
              })
      print("Probability by predict:", math.exp(-np.sum(log_probs)))
      print(grads)

if __name__ == "__main__":
  tf.app.run()
